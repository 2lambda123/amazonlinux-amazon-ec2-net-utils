# Testing net-utils #

## Introduction ##

There are two main components involved in testing this package:

1. ec2net-functions uses wrappers around network configuration tools
   such as `ip` and `ifup`.  By overriding these wrappers with
   equivalent functions that log their invocation rather than actually
   manipulate the system configuration, we are able compare the
   activity that would have been performed against a known-good
   baseline.

2. By injecting custom values in place of EC2 Instance Metadata
   values, we are able to test various different configurations.

## Adding new tests ##

### Writing the test ###

In most cases, you'll want to run all the existing tests but with a
custom set of parameters such as IMDS configuration.  For example, at
the moment the existing tests cover `ec2ifup`, `ec2ifdown`, and
`ec2dhcp.sh`.  If you want to add a new test of behavior giving a
specific IMDS configuration (e.g. multiple IP addresses, IPv6-only,
etc), create a test parameters file in which you'll provide the
various IMDS responses and other interface details.  The parameters
file names the test, so to create a new test named `foo`, the params
file should be named `params-foo.sh` Existing `params.*` can be used
as examples.

The current `params-eth0-basic.sh` file describes the following
configuration:

    #!/bin/bash
    # Basic eth0 configuration.  Single IPv4 address, no IPv6 configured.

    # Provide mandatory interface details: interface name and MAC address.
    # These will be needed with all test definitions.  It is OK to re-use
    # names and addresses across definitions, but beware that eth0 is
    # handled specially in the code and tests need to account for that.
    INTERFACE=eth0
    HWADDR=41:b0:34:a0:b0:c0

    # Replace /etc with something local and writable.  The Makefile makes
    # use of the test-output directory specifically when comparing test
    # output with known state.
    ETCDIR=./test-output/etc/
    
    # After defining the above variables, load the standard
    # ec2net-functions library and then load the test-functions
    # library, which provides the overrides of system management
    # tools.
    . ../ec2net-functions
    . ./test-functions
    
    # Override the get_meta function to provide test-specific values
    # for the various IMDS keys for our interface.  Below are the
    # basic keys that are queries when configuring any interface.  By
    # logging the invocations of this function, we are able to see
    # what calls are made for each key.  Changes in the behavior of
    # the components being testing will be reflected in the logs.  The
    # Makefile in this directory compares the output generated by a
    # given test run with the expected output.  Deviations from the
    # expected output are considered a test failure.
    get_meta() {
        echo "CALLED $FUNCNAME" $@ >&2
        case "$1" in
        subnet-ipv4-cidr-block)
            echo "192.168.10.0/24"
            ;;
        local-ipv4s)
            echo "192.168.10.10"
            ;;
        *)
            echo "unsupported request $1" >&2
            ;;
        esac
    }

### Generating the expected output ###

Expected output for a given test lives in the `tdata` subdirectory.
The Makefile provides a wildcard update target that can be used to
generate and save the output for a given test.  Invoke it like `make
update-foo`.  Then inspect the files stored in `tdata/foo` for
correctness.  If everything is good and you want to establish this as
a new baseline for the `foo` test, commit `tdata/foo` to git.

### Updating existing tests ###

Updating expected data for tests, for example if something changes in
the code that results in **expected** changes to the IMDS queries, you
can update the expected output using the same `update-foo` Makefile
target.
